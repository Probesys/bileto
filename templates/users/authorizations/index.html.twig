{#
 # This file is part of Bileto.
 # Copyright 2022-2024 Probesys
 # SPDX-License-Identifier: AGPL-3.0-or-later
 #}

{% extends 'base.html.twig' %}

{% set currentPage = 'settings' %}

{% block title %}{{ 'users.authorizations.index.title' | trans({ name: user.displayName }) }}{% endblock %}

{% block sidebar %}
    {{ include('settings/_sidebar.html.twig', { current: 'users' }, with_context = false) }}
{% endblock %}

{% block body %}
    <main class="layout__body flow roles-index">
        <div class="layout__breadcrumb">
            <a href="{{ path('users') }}">{{ 'users.index.title' | trans }}</a>
            <h1>{{ 'users.authorizations.index.title' | trans({ name: user.displayName }) }}</h1>
        </div>

        <div class="wrapper wrapper--large flow">
            {% if user.organization and not is_granted_to_user(user, 'orga:create:tickets', user.organization) %}
                <div class="wrapper wrapper--text">
                    {{ include('alerts/_alert.html.twig', {
                        type: 'warning',
                        title: 'common.warning' | trans,
                        message: 'users.no_organization_authorization' | trans({
                            path: path('new user authorization', { uid: user.uid, orga: user.organization.uid }),
                        }),
                        raw: true,
                    }) }}
                </div>
            {% endif %}

            <div class="grid">
                <a class="card card--action" href="{{ path('new user authorization', { uid: user.uid }) }}">
                    <span>
                        {{ icon('plus') }}
                        {{ 'users.authorizations.index.new_authorization' | trans }}
                    </span>
                </a>

                {% for authorization in authorizations %}
                    <div class="card flow" data-test="authorization-item">
                        <div class="card__title">
                            {% if authorization.role.type == 'super' %}
                                {{ icon('crown') }}
                                {{ 'roles.super_admin' | trans }}
                            {% else %}
                                {{ authorization.role.name }}
                            {% endif %}
                        </div>

                        <div class="card__body flow flow--small text--center">
                            {% if authorization.role.type == 'agent' or authorization.role.type == 'user' %}
                                <div>
                                    {% if authorization.role.type == 'agent' %}
                                        {{ 'roles.type.agent' | trans }}
                                    {% else %}
                                        {{ 'roles.type.user' | trans }}
                                    {% endif %}
                                </div>

                                <div class="text--secondary">
                                    {% if authorization.organization %}
                                        {{ authorization.organization.name }}
                                    {% else %}
                                        {{ 'roles.scope_global' | trans }}
                                    {% endif %}
                                </div>
                            {% else %}
                                <div>
                                    {{ 'roles.type.admin' | trans }}
                                </div>
                            {% endif %}
                        </div>

                        {% if (
                            authorization.role.type == 'super' and (
                                not is_granted('admin:*') or
                                app.user.id == authorization.holder.id
                            )
                        ) %}
                            <p class="text--secondary text--center text--small">
                                {{ 'users.authorizations.index.revoke.disabled' | trans }}
                            </p>
                        {% else %}
                            <form
                                class="text--center"
                                method="post"
                                action="{{ path('delete user authorization', { uid: authorization.uid }) }}"
                            >
                                <input type="hidden" name="_csrf_token" value="{{ csrf_token('delete user authorization') }}">
                                <button type="submit" data-turbo-confirm="{{ 'users.authorizations.index.revoke.confirm' | trans }}">
                                    {{ 'users.authorizations.index.revoke' | trans }}
                                </button>
                            </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </main>
{% endblock %}
